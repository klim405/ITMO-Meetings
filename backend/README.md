# API
## Формат запросов
```json
{
  "variable1": "value",
  "variable2": "value",
  "access_token": "access_token"
}
```
Все запросы, кроме запроса на получение токена и обновление токена, необходимо отправлять в данном формате. 
## Формат ответов
```json
{
  "object": {
    "field_name_1": "value",
    "field_name_2": 0,
    "field_name_3": true
  },
  "objects": [
    {
    "field_name_1": "value",
    "field_name_2": 0
  },
    {
    "field_name_1": "value",
    "field_name_2": 0
  }
  ],
  "validation_messages": {
    "field_name_1": [
      "error_message_code_1", 
      "error_message_code_2"
    ]
  },
  "errors": [
    {
      "error_name": "",
      "error_description": ""
    }
  ]
}
```
В ответе на запросы возвращается объект с атрибутами:
- ***object*** – атрибут хранящий запрошенные объект GET методом
- ***objects*** – атрибут хранящий запрошенные объекты GET методом
- ***validation_messages*** – атрибут хранящий названия ошибок валидации
- ***errors*** – обрабатываемые исключения

## Ошибки
### Валидационные ошибки
- **not_null** - Поле не должно быть пустым.
- **not_unique** - Поле не уникально.
- **value_out_of_range** - Значение поля вне допустимого диапазона.
- **max_value** - Значение поля больше максимально допустимого значение.
- **min_value** - Значение поля меньше минимально допустимого значение.
- **wrong_length** - Длина строки вне допустимого диапазона.
- **max_length** - Длина строки больше максимально допустимой длинны.
- **min_length** - Длина строки меньше минимально допустимой длинны.
- **is_empty** - Строка не должна быть пустой.
- **regex** - Поле не удовлетворяет шаблону регулярного выражения.
- **simple_password** - Пароль слишком легкий.
- **wrong_email** - Значение поля не является адресом электронной почты.
- **wrong_format** - Значение поля не верного формата и не может быть приведено к нужному типу на стороне сервера.
### Отлавливаемые ошибки
##### Ошибки авторизации (401)
- **user_inactive_error** - аккаунт пользователя деактивирован
- **token_type_error** - неверный тип токена, переданный в заголовке Authorization. Корректный формат "<тип токена> <токен>". Доступные типы: `Bearer`
- **token_expired_error** - Срок годности токена истек
- **token_error** - Нет заголовка 'Authorization' в запросе.
- **token_format_error** - Некорректный формат токена, токен должен соответствовать формату UUID.
## Идентификация
Каждый запрос должен сопровождаться отправкой токена пользователя. Подробнее об идентификации написано в данном разделе.
### Получение токена
Получить токен можно отправив POST запрос `api/auth/login/`, если аккаунт пользователя не деактивирован.
```json
{
  "username": "username or email or telephone",
  "password": "password"
}
```
В ответ на запрос вы получите токен `access_token` для запросов, токен `refresh_token` для обновления текущего токена, а также время истечения действия токена `expire_time`. Пример ответа на запрос ниже:
```json
{
  "access_token": "7808c97a-6ab6-45cf-acb3-540a1a4d56ce",
  "expire_in": 300,
  "refresh_token": "cd927122-d54b-49fb-9939-111bca0ac0bd",
  "token_type": "bearer"
}
```
Возможны исключения валидации: <br/>
`wrong_username` – имя пользователя не найдено<br/>
`wrong_password` – неверный пароль

### Обновления токена
Обновить токен можно отправив POST запрос `api/auth/refresh-access_token/`
```json
{
  "refresh_token": "you refresh-access_token here"
}
```
В ответ на запрос вы получите новый токен `access_token` для запросов, новый токен `refresh_token` для обновления текущего токена, а также время истечения действия токена `expire_time`. Пример ответа на запрос ниже:
```json
{
  "access_token": "3a0e0bca-1bb5-4f55-a2f7-e15e67ce96db",
  "expire_in": 300,
  "refresh_token": "d4269daf-939d-4847-8bb0-9767a0640b0b",
  "token_type": "bearer"
}

```
Возможны обрабатываемые исключения: <br/>
`invalid_refresh_token` – токен не найден в базе<br/>
`refresh_token_was_expired` – токен для обновления больше не действителен, возможно он был уже использован или был выполнен дистанционный выход.

### Деактивация токена
Деактивировать токен можно отправив POST запрос `api/auth/logout/`, деактивировать токен может либо пользователь инициализировавший его либо администратор сайта.
```json
{
  "access_token": "you access_token here"
}
```
Данных в ответе нет, `access_token` и `refresh-access_token` деактивируются.<br/>
Возможны валидационные ошибки: `wrong_format`, `not_null`.

### Деактивация всех токенов
Деактивировать токен можно отправив POST запрос `api/auth/logout-anywhere/`, деактивировать токен может либо пользователь инициализировавший его либо администратор сайта.
```json
{ }
```
Данных в ответе нет, все `access_token` и `refresh-access_token` пользователя деактивируются.<br/>

## REST API URL
| Метод  | Ссылка                      | Назначение                                          |
|--------|-----------------------------|-----------------------------------------------------|
| POST   | api/auth/login/             | Проверяет логин и пароль возвращает токен.          |
| POST   | api/auth/refresh/           | Создает новый токен.                                |
| POST   | api/auth/logout/            | Деактивирует токен.                                 |
| POST   | api/auth/logout-anywhere/   | Деактивирует все токены пользователя.               |
| POST   | api/auth/reset-password/    | Устанавливает новый пароль текущему пользователю    |
|        | api/auth/recovery-password/ | Восстанавливает пароль                              |
| GET    | api/user/                   | Возвращает информацию о текущем пользователе        |
| DELETE | api/user/                   | Деактивирует пользователя текущего пользователе     |
| POST   | api/user/registrate/        | Регистрирует пользователя                           |
| GET    | api/user/\<id\>/            | Возвращает информацию о пользователе с указанным id |
| PUT    | api/user/\<id\>/            | Обновляет информацию о пользователе с указанным id  |
| DELETE | api/user/\<id\>/            | Деактивирует пользователя с указанным id            |
| POST   | api/channel/                | Создаёт канал и возвращает объект                   |
| GET    | api/channel/\<id\>/         | Возвращает информация о канале                      |
| PUT    | api/channel/\<id\>/         | Обновляет информация о канале                       |
| DELETE | api/channel/\<id\>/         | Удаляет канал                                       |
| GET    | api/channel/personal/       | Возвращает личный канал пользователя                |
| GET    | api/channel/member/roles/   | Возвращает список права для каждой роли             |
|        |                             |                                                     |
|        |                             |                                                     |
|        |                             |                                                     |
|        |                             |                                                     |
|        |                             |                                                     |
|        |                             |                                                     |
|        |                             |                                                     |
|        |                             |                                                     |
|        |                             |                                                     |

## Работа с пользователями
### Регистрация
Зарегистрировать токен можно отправив POST запрос `api/user/registrate/`.
#### Данные формы
Формат данных json.

| Поле         | Уникальное | Обязательное | Тип     | Ограничения     | Regex                                         |
|--------------|------------|--------------|---------|-----------------|-----------------------------------------------|
| username     | +          | +            | string  |                 | `\w{3,20}`                                    |
| firstname    |            | +            | string  |                 | `[А-Яа-яA-Za-z\-]{1,20}`                      |
| patronymic   |            |              | string  |                 | `[А-Яа-яA-Za-z\-]{3,20}`                      |
| surname      |            | +            | string  |                 | `[А-Яа-яA-Za-z\-]{3,20}`                      |
| other_names  |            |              | string  |                 | `[А-Яа-яA-Za-z\-\s]{3,256}`                   |
| sex          |            | +            | string  | =male / =female |                                               |
| age          |            | +            | integer | > 0             |                                               |
| telephone    | +          | +            | string  |                 | `\+[\d]{11,15}`                               |
| email        | +          | +            | string  |                 | `\A[A-Z0-9+_.-]+@([A-Z0-9.-]+\.[A-Z]{2,6})\Z` |
| password     |            | +            | string  |                 | шаблон ниже                                   |

Шаблон пароля в формате строки: 
``` regexp
"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d+=\-~!@#$%^&*(){}\[\];:,.`'\"\\/|]{8}"
```

### Смена пароля
Сменить пароль авторизованного можно отправив POST запрос `api/auth/reset-password/`. Смена пароля доступна пользователю только для себя самого. Шаблон валидации пароля описан ранее.
#### Формат запроса
```json
{
  "password": "12345678"
}
```

### Получение данных текущего пользователя
Получить объект авторизованного можно отправив GET запрос `api/user/`.
#### Формат ответа

```json
{
  "object": {
    "age": 12,
    "confidentiality": 418,
    "email": "Test@test.ru",
    "favorite_categories": [
      {
        "id": 1,
        "name": "sport"
      }
    ],
    "firstname": "dddd",
    "id": 4,
    "is_active": true,
    "is_staff": false,
    "other_names": "dddd",
    "patronymic": null,
    "referrer_id": null,
    "sex": "male",
    "surname": "sss",
    "telephone": "+72330988989",
    "username": "testuser"
  }
}

```

### Получение данных пользователя
Получить объект произвольного пользователя можно отправив GET запрос `api/user/<id пользователя>/`. Данные будут возвращены в соответствии с настройками конфиденциальности. Если запрашивающий пользователь владеет статусом персонала, то будут возвращены все поля, игнорируя настройки конфиденциальности.
#### Формат ответа
Некоторые поля могут быть скрыты в соответствии с настройками конфиденциальности. Поэтому их значение будет null. Пример ответа со всеми максимально скрытыми полями.
```json
{
  "object": {
    "id": 5, 
    "firstname": "dddd", 
    "sex": "male", 
    "confidentiality": 0, 
    "is_active": true, 
    "is_staff": true, 
    
    "age": null,
    "email": null, 
    "favorite_categories": null,
    "other_names": null, 
    "patronymic": null, 
    "referrer_id": null, 
    "surname": null, 
    "telephone": null, 
    "username": null
  }
}
```

### Изменение данных пользователя
Изменить объект произвольного пользователя можно отправив PUT запрос `api/user/<id пользователя>/`.
Если текущий пользователь владеет статусом персонала. Он может редактировать поле is_staff.
#### Формат запроса
```json
{
  "field_1": "значение",
  "field_2": "значение"
}
```

### Деактивация пользователя
Для деактивации произвольного пользователя необходимо отправить DELETE запрос `api/user/<id пользователя>/`. 
Для текущего произвольного пользователя необходимо отправить DELETE запрос `api/user/`.
#### Формат ответа
```json
{ }
```

### Конфиденциальность пользователей
Конфиденциальность пользователей (user.confidentiality) - это число, 
если это число представить в двоичном формате, 
то каждый бит числа будет отвечать за конкретное разрешение конфиденциальности.

| Разрешение                         | Число         | 
|------------------------------------|---------------|
| Показывать аватарку                | 0b1 0000 0000 | 
| Показывать username                | 0b0 1000 0000 | 
| Показывать отчество или второе имя | 0b0 0100 0000 | 
| Показывать фамилию                 | 0b0 0010 0000 | 
| Показывать возраст                 | 0b0 0001 0000 | 
| Показывать телефон                 | 0b0 0000 1000 | 
| Показывать почту                   | 0b0 0000 0100 | 
| Показывать каналы                  | 0b0 0000 0010 | 
| Показывать категории               | 0b0 0000 0001 | 

### Восстановление пароля
[//]: # (todo: Восстановление пароля)

## Каналы
Канал бывает двух типов персональный и общественный:
- Персональный – канал у которого один владелец 
и нет администраторов, кроме самого владельца. 
Создается сразу при добавлении пользователя. Пользователь не может удалить канал.
- Общественный – канал у которого один владелец, 
несколько администраторов и редакторов. 
Право владельца может быть передано, если владелец покинет канал,
права владельца передадутся на одного из подписчика
с наивысшим уровнем прав.

### Создание канала
Для создания канала необходимо отправить POST запрос `api/channel/`
#### Доступные поля
| Поле                     | Уникальное | Обязательное | Тип    | Ограничения   |
|--------------------------|------------|--------------|--------|---------------|
| name                     |            | +            | string | length <= 100 |
| description              |            |              | text   |               |
| is_require_confirmation  |            |              | bool   |               |
#### Формат ответа
```json
{
  "object": {
    "description": null, 
    "id": 31, 
    "is_personal": false, 
    "is_require_confirmation": false, 
    "name": "channel name", 
    "rating": null
  }
}
```

### Редактирование информации о канале 
Для редактирования канала необходимо отправить GET запрос `api/channel/<id канала>/`
#### Формат ответа
```json
{
  "object": {
    "description": null, 
    "id": 31, 
    "is_personal": false, 
    "is_require_confirmation": false, 
    "name": "channel name", 
    "rating": null
  }
}
```

### Редактирование информации о канале 
Для редактирования канала необходимо отправить PUT запрос `api/channel/<id канала>/`
Редактировать канал может участник имеющий право редактирования (Permission.UPDATE_CHANNEL)
#### Доступные поля
| Поле                     | Уникальное | Обязательное | Тип    | Ограничения   |
|--------------------------|------------|--------------|--------|---------------|
| name                     |            | +            | string | length <= 100 |
| description              |            |              | text   |               |
| is_require_confirmation  |            |              | bool   |               |
#### Формат ответа
Обновленный объект канала

### Удаление канала
Для удаления канала необходимо отправить DELETE запрос `api/channel/<id канала>/`.
Для удаления необходимо право на удаление (Permission.DELETE_CHANNEL)
#### Формат ответа
```json
{ }
```

## Участники канала
### Список участников
Для получения списка участников канала необходимо отправить GET запрос `api/channel/<id канала>/member/list`.
#### Формат ответа
```json
{
  "list": [
    {
      "channel_id": 48, 
      "date_of_join": "Sun, 12 Nov 2023 17:53:40 GMT", 
      "notify_about_meeting": false, 
      "permissions": 255, 
      "user_id": 10
    }
  ]
}
```

### Система подпиской
#### Подписка на канал
#### Изменение правил подписки
#### Отписка от канала
### Удаление канала